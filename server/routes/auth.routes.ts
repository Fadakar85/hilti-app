// server/routes/auth.routes.ts
import express, { Request, Response } from 'express';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { createUser, findUserByPhone, comparePassword } from '../models/user.model.js';  // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø§ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯.
import { login, register } from '../controllers/authController.js';

const router = express.Router();
router.post('/register', register); // ğŸ“Œ Ù…Ø³ÛŒØ± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯

// Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
router.post('/register', async (req: Request, res: any) => {
  const { phone, password } = req.body;

  // Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
  if (!phone || !password) {
    return res.status(400).json({ error: 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª' });
  }

  // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª
  const existingUser = await findUserByPhone(phone);
  if (existingUser) {
    return res.status(400).json({ error: 'Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª' });
  }

  // Ù‡Ø´ Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
  const hashedPassword: string = await bcrypt.hash(password, 10) as string;

  res.status(201).json({ message: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯' });
});

// ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…
router.post('/login', async (req: Request, res: any) => {
  const { phone, password } = req.body;

  // Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
  if (!phone || !password) {
    return res.status(400).json({ error: 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª' });
  }

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
  const user = await findUserByPhone(phone);
  if (!user) {
    return res.status(404).json({ error: 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯' });
  }

  // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡
  const isPasswordValid = await comparePassword(password, user.password);
  if (!isPasswordValid) {
    return res.status(401).json({ error: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª' });
  }

  // ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† JWT
  const token = jwt.sign(
    { id: user.id, phone: user.phone, role: user.role }, 
    process.env.JWT_SECRET!, 
    { expiresIn: '1h' }
  );

  res.status(200).json({ message: 'ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯', token });
});

export default router;